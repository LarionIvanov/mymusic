<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ú–æ—è –º—É–∑—ã–∫–∞</title>
  <style>
    body {
      font-family: sans-serif;
      background: white;
      color: #222;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
    }

    h1 {
      margin-bottom: 1rem;
    }

    #upload-section {
      margin-bottom: 2rem;
      border: 2px dashed #ccc;
      padding: 1.5rem;
      border-radius: 10px;
      width: 320px;
      text-align: center;
    }

    #music-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      width: 320px;
    }

    .track {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      border: 1px solid #ddd;
      padding: 1rem;
      border-radius: 8px;
      background: #fafafa;
    }

    audio {
      width: 100%;
      margin-top: 0.5rem;
    }
  </style>
</head>
<body>
  <h1>üéµ –ú–æ—è –º—É–∑—ã–∫–∞</h1>

  <div id="upload-section">
    <input type="file" id="fileInput" accept="audio/*" />
    <button id="uploadButton">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç—Ä–µ–∫</button>
    <p id="status"></p>
  </div>

  <div id="audioList"></div>

  <script type="module">
  import { Client, Storage, Account, ID } from "https://cdn.jsdelivr.net/npm/appwrite@13.0.0/+esm";

  // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Appwrite
  const client = new Client()
    .setEndpoint('https://cloud.appwrite.io/v1')
    .setProject('68edff2c00028e4b809b');

  const account = new Account(client);
  const storage = new Storage(client);
  const bucketId = '68edff670001c6096f18';

  const fileInput = document.getElementById('fileInput');
  const uploadButton = document.getElementById('uploadButton');
  const audioList = document.getElementById('audioList');
  const statusText = document.getElementById('status');

  // –°–æ–∑–¥–∞—ë–º –∞–Ω–æ–Ω–∏–º–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ)
  async function ensureAnonymousSession() {
    try {
      await account.get();
    } catch {
      await account.createAnonymousSession();
    }
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ç—Ä–µ–∫–æ–≤
  async function loadTracks() {
    try {
      const result = await storage.listFiles(bucketId);
      audioList.innerHTML = '';

      for (const file of result.files) {
        const fileUrl = `https://cloud.appwrite.io/v1/storage/buckets/${bucketId}/files/${file.$id}/view?project=68edff2c00028e4b809b`;

        const trackDiv = document.createElement('div');
        trackDiv.classList.add('track');
        trackDiv.innerHTML = `
          <strong>${file.name}</strong>
          <audio controls src="${fileUrl}"></audio>
        `;
        audioList.appendChild(trackDiv);
      }
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤:', error);
      statusText.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–ø–∏—Å–∫–∞ —Ç—Ä–µ–∫–æ–≤!';
    }
  }

  // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ–≥–æ —Ç—Ä–µ–∫–∞
  uploadButton.addEventListener('click', async () => {
    const file = fileInput.files[0];
    if (!file) {
      statusText.textContent = "–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª!";
      return;
    }

    statusText.textContent = "‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...";
    try {
      await storage.createFile(bucketId, ID.unique(), file);
      statusText.textContent = "‚úÖ –¢—Ä–µ–∫ –∑–∞–≥—Ä—É–∂–µ–Ω!";
      fileInput.value = "";
      await loadTracks();
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞:', error);
      statusText.textContent = "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ!";
    }
  });

  // –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
(async () => {
  await ensureAnonymousSession();
  await loadTracks();
  enableAutoPlay();
})();

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è —Ç—Ä–µ–∫–æ–≤
function enableAutoPlay() {
  const audios = document.querySelectorAll("audio");

  audios.forEach((audio, index) => {
    audio.addEventListener("ended", () => {
      const nextAudio = audios[index + 1];
      if (nextAudio) {
        nextAudio.play();
      } else {
        // –ï—Å–ª–∏ —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ç—Ä–µ–∫ ‚Äî –º–æ–∂–Ω–æ –∑–∞—Ü–∏–∫–ª–∏—Ç—å —Å–ø–∏—Å–æ–∫
        const firstAudio = audios[0];
        if (firstAudio) firstAudio.play();
      }
    });
  });
}

</script>
</body>
</html>
