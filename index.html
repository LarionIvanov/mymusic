<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>–ú–æ—è –º—É–∑—ã–∫–∞</title>
  <style>
    body {
      font-family: sans-serif;
      background: white;
      color: #222;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
    }

    h1 {
      margin-bottom: 1rem;
    }

    #upload-section {
      margin-bottom: 2rem;
      border: 2px dashed #ccc;
      padding: 1.5rem;
      border-radius: 10px;
      width: 320px;
      text-align: center;
      transition: all 0.3s ease;
    }

    #upload-section:hover {
      border-color: #888;
      background: #f9f9f9;
    }

    #audioList {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      width: 320px;
    }

    .track {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      border: 1px solid #ddd;
      padding: 1rem;
      border-radius: 8px;
      background: #fafafa;
      transition: all 0.2s ease;
      user-select: none;
      -webkit-user-select: none;
      -ms-user-select: none;
      touch-action: none;
      position: relative;
      cursor: default; /* ‚úÖ –∫—É—Ä—Å–æ—Ä –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è */
    }

    .track.dragging {
      opacity: 0.6;
      background: #e0f7fa;
      transform: scale(1.02);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    audio {
      width: 100%;
      margin-top: 0.5rem;
    }

    html, body {
      touch-action: manipulation;
      -webkit-text-size-adjust: 100%;
    }

    button, input, strong, h1, .track {
      touch-action: manipulation;
    }

    .settings-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.5);
      border: none;
      border-radius: 50%;
      font-size: 1.5rem;
      padding: 0.5rem 0.6rem;
      backdrop-filter: blur(10px);
      box-shadow: 0 0 8px rgba(0,0,0,0.2);
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .settings-btn:hover {
      background: rgba(255, 255, 255, 0.7);
      transform: rotate(30deg);
    }

    /* === –ö–Ω–æ–ø–∫–∞ ‚ãØ === */
    .menu-button {
      position: absolute;
      top: 8px;
      right: 8px;
      background: rgba(255, 255, 255, 0.25);
      border: none;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      font-size: 18px;
      color: #222;
      cursor: pointer;
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      -webkit-tap-highlight-color: transparent;
    }

    .menu-button:hover {
      background: rgba(255, 255, 255, 0.5);
      transform: scale(1.1);
    }

    .menu-button:active {
      transform: none; /* ‚úÖ —É–±–∏—Ä–∞–µ–º –º–∏–≥–∞–Ω–∏–µ */
    }

    /* === –ú–∏–Ω–∏-–º–æ–¥–∞–ª–∫–∞ —Ä—è–¥–æ–º —Å —Ç—Ä–µ–∫–æ–º === */
    .mini-modal {
      position: absolute;
      background: rgba(255,255,255,0.25);
      backdrop-filter: blur(20px);
      border-radius: 12px;
      padding: 0.5rem 1rem;
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
      opacity: 0;
      transform: scale(0.9);
      transition: opacity 0.15s ease, transform 0.15s ease;
      z-index: 9999;
    }

    .mini-modal.show {
      opacity: 1;
      transform: scale(1);
    }

    .rename-btn {
      background: rgba(255,255,255,0.35);
      border: none;
      border-radius: 8px;
      padding: 6px 14px;
      font-size: 15px;
      color: #000;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .rename-btn:hover {
      background: rgba(255,255,255,0.55);
    }

    /* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä */
    .progress-bar {
      width: 100%;
      height: 14px;
      background: rgba(255,255,255,0.2);
      border-radius: 10px;
      overflow: hidden;
      margin: 1rem 0;
    }

    .progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #34c759, #00c3ff);
      border-radius: 10px;
      transition: width 0.6s ease;
    }
  </style>
</head>
<body>
  <h1>üéµ –ú–æ—è –º—É–∑—ã–∫–∞</h1>

  <div id="upload-section">
    <input type="file" id="fileInput" accept="audio/*" />
    <button id="uploadButton">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç—Ä–µ–∫</button>
    <p id="status"></p>
  </div>

  <div id="audioList"></div>

  <button id="settingsButton" class="settings-btn">‚öôÔ∏è</button>

  <div id="storageModal" class="modal hidden">
    <div class="modal-content">
      <h2>–•—Ä–∞–Ω–∏–ª–∏—â–µ</h2>
      <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
      <p id="storageInfo"></p>
    </div>
  </div>

  <script>
    // --- –û—Ç–∫–ª—é—á–∞–µ–º –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ Safari ---
    let lastTouchEnd = 0;
    document.addEventListener('touchend', e => {
      const now = Date.now();
      if (now - lastTouchEnd <= 300) e.preventDefault();
      lastTouchEnd = now;
    }, { passive: false });
  </script>

  <script type="module">
    import { Client, Storage, Account, ID, Databases } from "https://cdn.jsdelivr.net/npm/appwrite@13.0.0/+esm";

    const client = new Client()
      .setEndpoint("https://cloud.appwrite.io/v1")
      .setProject("68edff2c00028e4b809b");
    const account = new Account(client);
    const storage = new Storage(client);
    const databases = new Databases(client);

    const bucketId = "68edff670001c6096f18";
    const databaseId = "68fa77bf00299325c262";
    const collectionId = "tracks_order";
    const documentId = "68fa7961001aa4c376a6";

    const fileInput = document.getElementById("fileInput");
    const uploadButton = document.getElementById("uploadButton");
    const audioList = document.getElementById("audioList");

    async function ensureAnonymousSession() {
      try { await account.get(); }
      catch { await account.createAnonymousSession(); }
    }

    // === –ú–æ–¥–∞–ª–∫–∞ –¥–ª—è –∫–Ω–æ–ø–∫–∏ ‚ãØ ===
    const miniModal = document.createElement("div");
    miniModal.classList.add("mini-modal");
    miniModal.innerHTML = `<button id="renameBtn" class="rename-btn">–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å</button>`;
    document.body.appendChild(miniModal);

    const renameBtn = miniModal.querySelector("#renameBtn");
    let currentFile = null, currentTitleEl = null;

    renameBtn.addEventListener("click", async () => {
      miniModal.classList.remove("show");
      const newName = prompt("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è —Ç—Ä–µ–∫–∞:", currentFile.name);
      if (newName && newName.trim() && newName !== currentFile.name) {
        try {
          await storage.updateFile(bucketId, currentFile.$id, { name: newName.trim() });
          currentFile.name = newName.trim();
          currentTitleEl.textContent = currentFile.name;
        } catch (error) {
          console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∏–º–µ–Ω–∏:", error.message);
        }
      }
    });

    function openRenameModal(file, titleEl, button) {
      currentFile = file;
      currentTitleEl = titleEl;
      const rect = button.getBoundingClientRect();
      miniModal.style.top = `${rect.bottom + 6 + window.scrollY}px`;
      miniModal.style.left = `${rect.right - 160}px`;
      miniModal.classList.add("show");
    }

    document.addEventListener("click", e => {
      if (!miniModal.contains(e.target) && !e.target.classList.contains("menu-button")) {
        miniModal.classList.remove("show");
      }
    });

    async function loadTracks() {
      const orderDoc = await databases.getDocument(databaseId, collectionId, documentId);
      let order = [];
      try { order = JSON.parse(orderDoc.order || "[]"); } catch {}
      const files = await storage.listFiles(bucketId);
      const map = Object.fromEntries(files.files.map(f => [f.$id, f]));
      const sorted = order.map(id => map[id]).filter(Boolean)
        .concat(files.files.filter(f => !order.includes(f.$id)));
      audioList.innerHTML = "";
      for (const file of sorted) {
        const url = `https://cloud.appwrite.io/v1/storage/buckets/${bucketId}/files/${file.$id}/view?project=68edff2c00028e4b809b`;
        const div = document.createElement("div");
        div.classList.add("track");
        div.draggable = true;
        div.dataset.id = file.$id;
        const title = document.createElement("strong");
        title.textContent = file.name;

        // –¥–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ (–ü–ö)
        title.addEventListener("dblclick", () => {
          const input = document.createElement("input");
          input.type = "text";
          input.value = file.name;
          input.style.width = "90%";
          input.style.font = "inherit";
          title.replaceWith(input);
          input.focus();
          input.addEventListener("keydown", e => {
            if (e.key === "Enter") finish(true);
            if (e.key === "Escape") finish(false);
          });
          input.addEventListener("blur", () => finish(true));
          async function finish(save) {
            if (save && input.value.trim() && input.value !== file.name) {
              await storage.updateFile(bucketId, file.$id, { name: input.value.trim() });
              file.name = input.value.trim();
            }
            input.replaceWith(title);
            title.textContent = file.name;
          }
        });

        const btn = document.createElement("button");
        btn.textContent = "‚ãØ";
        btn.classList.add("menu-button");
        btn.addEventListener("click", e => {
          e.stopPropagation();
          openRenameModal(file, title, btn);
        });

        const audio = document.createElement("audio");
        audio.controls = true;
        audio.src = url;

        div.append(btn, title, audio);
        audioList.appendChild(div);
      }
      enableDragAndDrop();
      enableAutoPlay();
    }

    async function saveOrder() {
      const order = [...audioList.children].map(e => e.dataset.id);
      await databases.updateDocument(databaseId, collectionId, documentId, {
        order: JSON.stringify(order),
      });
    }

    function enableAutoPlay() {
      const audios = document.querySelectorAll("audio");
      audios.forEach(a => {
        a.addEventListener("play", () => audios.forEach(b => b !== a && (b.pause(), b.currentTime = 0)));
        a.addEventListener("ended", () => {
          const next = audios[[...audios].indexOf(a) + 1];
          if (next) next.play();
        });
      });
    }

    function enableDragAndDrop() {
      let dragged = null;
      audioList.addEventListener("dragstart", e => {
        dragged = e.target.closest(".track");
        if (!dragged) return;
        dragged.classList.add("dragging");
        e.dataTransfer.effectAllowed = "move";
      });
      audioList.addEventListener("dragend", () => {
        if (dragged) dragged.classList.remove("dragging");
        dragged = null;
        saveOrder();
      });
      audioList.addEventListener("dragover", e => {
        e.preventDefault();
        const target = e.target.closest(".track");
        if (!target || target === dragged) return;
        const rect = target.getBoundingClientRect();
        const next = e.clientY > rect.top + rect.height / 2;
        audioList.insertBefore(dragged, next ? target.nextSibling : target);
      });
    }

    (async () => {
      await ensureAnonymousSession();
      await loadTracks();
    })();
  </script>
</body>
</html>
